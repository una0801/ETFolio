# ETFolio 계산 로직 상세 가이드

이 문서는 ETFolio에서 사용하는 모든 금융 지표 계산 방법을 상세히 설명합니다.

---

## 📊 기본 금융 지표

### 1. 총 수익률 (Total Return)

**공식**
```
총 수익률 = ((종가 - 시작가) / 시작가) × 100
```

**설명**
- 단순히 처음 가격과 마지막 가격을 비교한 수익률
- 복리 효과는 고려하지 않음

**예시**
```
100만원 투자 → 5년 후 150만원
총 수익률 = ((150 - 100) / 100) × 100 = 50%
```

**한계점**
- 기간이 다르면 비교 불가 (1년 50% vs 5년 50%는 전혀 다름)
- 그래서 장기 투자는 CAGR을 사용

---

### 2. CAGR (연평균 복리 수익률)

**공식**
```
CAGR = ((종가 / 시작가) ^ (1 / 년수) - 1) × 100
```

**설명**
- "매년 평균적으로 몇 %씩 수익이 났는가?"
- 복리 효과를 고려한 진짜 연평균 수익률
- 기간이 달라도 비교 가능 (투자 업계 표준)

**예시**
```
100만원 → 5년 후 200만원

총 수익률: 100%
CAGR: (200/100)^(1/5) - 1 = 0.1487 = 14.87%

의미: 매년 평균 14.87%씩 복리로 성장했다
```

**왜 CAGR을 쓰나?**
| 지표 | 1년 투자 | 5년 투자 | 비교 가능? |
|------|---------|---------|-----------|
| 총 수익률 | 50% | 50% | ❌ (기간이 다름) |
| CAGR | 50% | 8.45% | ✅ (연평균이므로 비교 가능) |

**계산 코드 위치**: `app/services/analytics_service.py` - `calculate_cagr()`

---

### 3. 변동성 (Volatility)

**공식**
```
변동성 = 일일 수익률의 표준편차 × √252 × 100
```

**설명**
- "가격이 얼마나 들쭉날쭉한가?"를 측정
- 높을수록 위험하고, 낮을수록 안정적
- 252 = 1년 거래일 수 (주말 제외)

**계산 과정**
1. 일일 수익률 계산: `(오늘 가격 - 어제 가격) / 어제 가격`
2. 표준편차 계산 (평균에서 얼마나 벗어나는지)
3. √252를 곱해서 연환산 (왜 제곱근? → 확률 이론)
4. 100을 곱해서 %로 변환

**예시**
```
일일 수익률: 0.5%, 1.2%, -0.8%, 0.3%, -0.5% ...
표준편차: 0.01 (1%)
연환산 변동성 = 1% × √252 × 100 = 15.87%
```

**해석**
| 변동성 | 평가 | 예시 |
|--------|------|------|
| 10% 미만 | 매우 안정적 | 채권 ETF |
| 10~20% | 안정적 | 대형주 ETF (SPY, VOO) |
| 20~30% | 보통 | 일반 주식 ETF |
| 30% 이상 | 변동성 높음 | 섹터 ETF, 레버리지 |

**계산 코드 위치**: `app/services/analytics_service.py` - `calculate_volatility()`

---

### 4. 샤프 비율 (Sharpe Ratio)

**공식**
```
샤프 비율 = (CAGR - 무위험 수익률) / 변동성
```

**설명**
- "위험 1%당 얼마나 수익을 냈는가?"
- 투자 효율성을 나타내는 가장 중요한 지표
- 노벨 경제학상 수상자 윌리엄 샤프가 개발

**계산 과정**
1. 초과 수익률 = CAGR - 무위험 수익률 (국채 2%)
2. 초과 수익률 ÷ 변동성

**예시**
```
A ETF: CAGR 15%, 변동성 20%
샤프 = (15 - 2) / 20 = 0.65

B ETF: CAGR 15%, 변동성 10%
샤프 = (15 - 2) / 10 = 1.30

→ 같은 수익이지만 B가 훨씬 효율적!
```

**왜 무위험 수익률을 빼나?**
- 은행 예금도 2% 정도는 벌 수 있음 (거의 무위험)
- 주식은 위험을 감수하는 것이므로
- "무위험 자산보다 얼마나 더 벌었는지"가 중요

**해석**
| 샤프 비율 | 평가 |
|-----------|------|
| 1.0 미만 | 효율성 낮음 |
| 1.0 ~ 2.0 | 양호 |
| 2.0 ~ 3.0 | 매우 좋음 |
| 3.0 이상 | 탁월함 (거의 없음) |

**계산 코드 위치**: `app/services/analytics_service.py` - `calculate_sharpe_ratio()`

---

### 5. MDD (최대 낙폭, Maximum Drawdown)

**공식**
```
MDD = ((현재가 - 최고가) / 최고가) × 100 중 최솟값
```

**설명**
- "역대 최고가에서 얼마나 떨어졌었는가?"
- 투자 심리적으로 가장 중요한 지표
- "내가 최악의 타이밍에 샀다면?"

**계산 과정**
1. 각 시점까지의 누적 최고가 계산
2. 현재가 - 누적 최고가 차이 계산
3. 비율로 환산
4. 모든 기간 중 최악의 낙폭 선택

**예시**
```
가격 변화: 100 → 150 → 120 → 180 → 100

150에서 120: -20% 낙폭
180에서 100: -44.4% 낙폭 ← MDD!

의미: 최악의 경우 44.4% 손실을 견뎌야 했음
```

**왜 중요한가?**
- 수익률이 높아도 MDD가 크면 심리적으로 버티기 어려움
- 예: CAGR 20%, MDD 60% → 대부분 손절
- 적립식 투자에서 특히 중요 (하락장에도 계속 사야 함)

**해석**
| MDD | 평가 | 예시 |
|-----|------|------|
| 10% 미만 | 매우 안정적 | 국채 |
| 10~20% | 안정적 | 배당 ETF |
| 20~30% | 보통 | 일반 주식 ETF |
| 30~50% | 높음 | 섹터 ETF |
| 50% 이상 | 매우 높음 | 레버리지 |

**계산 코드 위치**: `app/services/analytics_service.py` - `calculate_max_drawdown()`

---

### 6. 배당 수익률 (Dividend Yield)

**공식**
```
배당 수익률 = (연간 배당금 / 현재 주가) × 100
```

**설명**
- "주가 대비 연간 배당금이 얼마인가?"
- 은행 이자율과 비교 가능
- 시세 차익 외에 정기적인 현금 수입

**예시**
```
현재 주가: 10만원
연간 배당금: 3,000원
배당 수익률 = (3,000 / 100,000) × 100 = 3%

의미: 주식을 보유하면 연간 3%의 현금 배당
```

**배당 ETF 전략**
| 배당 수익률 | 평가 |
|------------|------|
| 1% 미만 | 낮음 |
| 1~3% | 보통 |
| 3~5% | 양호 |
| 5% 이상 | 매우 좋음 |

**주의사항**
- 배당률이 너무 높으면 (>10%) 의심
  - 회사가 어려워서 주가 폭락했을 수도
- 배당 컷 (삭감) 위험 고려
- 미국 ETF는 배당세 15% 원천징수

**계산 코드 위치**: `app/services/analytics_service.py` - `calculate_dividend_yield()`

---

## 🔗 상관관계 분석

### 상관계수 (Correlation Coefficient)

**공식**
```
상관계수 = 두 ETF 일일 수익률의 피어슨 상관관계
```

**설명**
- "두 ETF가 얼마나 비슷하게 움직이는가?"
- -1 ~ +1 사이의 값

**해석**
| 상관계수 | 의미 | 분산투자 효과 |
|---------|------|--------------|
| +1.0 | 완전히 같은 방향 | ❌ 없음 |
| +0.7 ~ +0.9 | 매우 높은 상관관계 | ⚠️ 거의 없음 |
| +0.3 ~ +0.7 | 중간 상관관계 | △ 보통 |
| 0.0 | 무관계 | ✅ 이상적 |
| -0.3 ~ -0.7 | 역상관 | ✅ 매우 좋음 |
| -1.0 | 완전 반대 방향 | ✅ 헤지 효과 |

**예시**
```
SPY (S&P 500) vs QQQ (나스닥)
상관계수: 0.85

→ 둘 다 미국 대형 기술주 중심
→ 거의 같이 움직임
→ 분산투자 효과 거의 없음
```

**계산 코드 위치**: `app/services/correlation_service.py` - `calculate_correlation_matrix()`

---

### 분산투자 점수 (Diversification Score)

**공식**
```
분산투자 점수 = (1 - 평균 상관계수) × 100
```

**설명**
- 포트폴리오 전체의 분산 정도를 0~100점으로 평가
- 평균 상관계수가 낮을수록 높은 점수

**계산 과정**
1. 모든 ETF 쌍의 상관계수 계산
2. 평균 계산 (자기 자신 제외)
3. (1 - 평균) × 100

**예시**
```
포트폴리오: SPY, QQQ, AGG (채권)

SPY vs QQQ: 0.85
SPY vs AGG: 0.15
QQQ vs AGG: 0.10

평균 상관계수 = (0.85 + 0.15 + 0.10) / 3 = 0.37
분산투자 점수 = (1 - 0.37) × 100 = 63점 (양호)
```

**해석**
| 점수 | 평가 | 조언 |
|------|------|------|
| 80~100 | 매우 우수 | 잘 분산됨 |
| 60~80 | 우수 | 양호한 수준 |
| 40~60 | 보통 | 다른 자산군 추가 권장 |
| 20~40 | 개선 필요 | 상관관계 낮은 ETF 추가 |
| 0~20 | 위험 | 포트폴리오 재구성 필요 |

**계산 코드 위치**: `app/services/correlation_service.py` - `analyze_diversification()`

---

## 🎯 ETF 추천 로직

### 1. 고수익형 (High Return)

**기준**: CAGR만 고려

**대상**: 높은 위험을 감수할 수 있는 공격적 투자자

**특징**: 변동성이나 낙폭은 무시하고 순수 수익률만

---

### 2. 안정형 (Stable)

**공식**
```
점수 = 샤프 비율 / (변동성 + 1)
```

**설명**
- 위험 대비 효율성 중시
- 같은 샤프 비율이라도 변동성 낮은 것 우선
- `+1`을 하는 이유: 0으로 나누기 방지, 극단값 완화

**대상**: 은퇴 준비, 원금 보존 중시

---

### 3. 고배당형 (High Dividend)

**기준**: 배당 수익률만 고려

**대상**: 은퇴자, 현금 흐름 필요, 배당 재투자 전략

---

### 4. 균형형 (Balanced)

**공식**
```
점수 = CAGR × 40% + 샤프 비율 × 20 + (100 - MDD) × 40%
```

**가중치 이유**
- MDD 40%: 손실 방어가 장기 투자에서 매우 중요
- CAGR 40%: 수익률도 MDD와 동등하게
- 샤프 20%: 효율성은 보조 지표

**대상**: 대부분의 일반 투자자

---

### 5. 적립식 (Monthly Investing)

**공식**
```
점수 = (100 - MDD) × 50% + CAGR × 30% + (20 - 변동성) × 20%
```

**가중치 이유**
- MDD 50%: 적립식은 하락장에서도 계속 사야 함
  - 큰 낙폭 = 심리적 부담 → 중도 포기
- CAGR 30%: 장기적으로 우상향해야 함
- 변동성 20%: 20% 이상이면 0점 처리
  - 들쭉날쭉하면 평균 단가 불안정

**대상**: 월급쟁이, 초보 투자자, 장기 적립식

**왜 이렇게 설계했나?**
- 적립식 투자 = Dollar Cost Averaging (DCA)
- 하락장에서도 계속 매수 → MDD가 가장 중요
- 예: MDD 50% ETF는 심리적으로 버티기 어려움

---

### 6. 인기순 (Popular)

**기준**: 평균 일일 거래량

**의미**
- 거래량 많다 = 유동성 좋다 = 사고팔기 쉽다
- 스프레드 좁아서 거래 비용 절감
- 많은 사람이 거래 = 시장 검증

**대상**: 단기 매매자, 유동성 중시

**주의**: 거래량 많다고 수익률이 좋은 건 아님

---

### 7. 투자유치 TOP (High AUM)

**기준**: 총 자산 규모 (AUM, Assets Under Management)

**의미**
- 자산 크다 = 기관 투자자 신뢰
- 상장폐지 위험 거의 없음
- 규모의 경제 → 보수 낮음
- 유동성 뛰어남

**대상**: 안정성 최우선

**예시**: SPY (약 $500B), VOO (약 $400B)

---

## 🧮 수학적 배경

### 왜 √252를 곱하나? (변동성 연환산)

**이론적 배경**: 브라운 운동 (Brownian Motion)
```
σ_연간 = σ_일일 × √T

T = 거래일 수 = 252일
```

**직관적 설명**
- 변동성은 시간에 비례하지 않음
- 시간의 **제곱근**에 비례 (확률 이론)
- 예: 2배 기간 = √2배 변동성 (2배 아님!)

---

### 왜 CAGR은 거듭제곱인가?

**복리의 수학**
```
최종 금액 = 초기 금액 × (1 + r)^n

r = CAGR (연율)
n = 년수

역산하면:
r = (최종/초기)^(1/n) - 1
```

**예시**
```
100만원 → 5년 후 200만원

200 = 100 × (1 + r)^5
(1 + r)^5 = 2
1 + r = 2^(1/5) = 1.1487
r = 0.1487 = 14.87%
```

---

## 📚 참고 자료

### 금융 이론
- 샤프 비율: William F. Sharpe (1966)
- 현대 포트폴리오 이론: Harry Markowitz (1952)
- CAPM: Treynor, Sharpe, Lintner, Mossin (1960s)

### 업계 표준
- CFA Institute (공인재무분석사)
- Morningstar 등급 시스템
- Bloomberg Terminal 지표

### 구현 참고
- `pandas-ta`: 기술적 지표 라이브러리
- `yfinance`: Yahoo Finance API
- `quantstats`: 퀀트 분석 라이브러리

---

## ⚠️ 면책 조항

이 문서의 모든 계산 방법과 추천 로직은:
- 일반적인 금융 이론에 기반하지만
- **절대적인 정답이 아니며**
- 과거 데이터를 기반으로 하므로
- **미래 수익을 보장하지 않습니다**

투자 결정은 본인의 판단과 책임 하에 이루어져야 합니다.

---

**작성일**: 2025-10-01  
**버전**: 1.0  
**작성자**: ETFolio Development Team

